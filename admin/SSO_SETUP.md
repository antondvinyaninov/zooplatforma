# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ SSO –¥–ª—è –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏

–ë—ã—Å—Ç—Ä–æ–µ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ –Ω–∞—Å—Ç—Ä–æ–π–∫–µ Single Sign-On –¥–ª—è –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏.

---

## üéØ –ß—Ç–æ —Ç–∞–∫–æ–µ SSO?

Single Sign-On (SSO) - —ç—Ç–æ —Å–∏—Å—Ç–µ–º–∞ –µ–¥–∏–Ω–æ–π –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –¥–ª—è –≤—Å–µ—Ö –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å–æ–≤ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—Ö–æ–¥–∏—Ç –æ–¥–∏–Ω —Ä–∞–∑ –Ω–∞ –æ—Å–Ω–æ–≤–Ω–æ–º —Å–∞–π—Ç–µ, –∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–ª—É—á–∞–µ—Ç –¥–æ—Å—Ç—É–ø –∫–æ –≤—Å–µ–º —Å–µ—Ä–≤–∏—Å–∞–º (–∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å, –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ –∏ —Ç.–¥.).

---

## üöÄ –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

### 1. –°–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä–≤–æ–≥–æ —Å—É–ø–µ—Ä–∞–¥–º–∏–Ω–∞

```bash
cd admin/backend

# –°–Ω–∞—á–∞–ª–∞ —É–∑–Ω–∞–π—Ç–µ ID –≤–∞—à–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
sqlite3 ../../database/data.db "SELECT id, name, email FROM users;"

# –ù–∞–∑–Ω–∞—á—å—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å—É–ø–µ—Ä–∞–¥–º–∏–Ω–æ–º (–∑–∞–º–µ–Ω–∏—Ç–µ 1 –Ω–∞ –≤–∞—à ID)
./create-superadmin.sh 1
```

### 2. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ JWT_SECRET –æ–¥–∏–Ω–∞–∫–æ–≤—ã–π

–ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –≤ –æ–±–æ–∏—Ö `.env` —Ñ–∞–π–ª–∞—Ö –æ–¥–∏–Ω–∞–∫–æ–≤—ã–π `JWT_SECRET`:

```bash
# backend/.env
JWT_SECRET=your-super-secret-key-min-32-chars

# admin/backend/.env
JWT_SECRET=your-super-secret-key-min-32-chars
```

**–í–∞–∂–Ω–æ:** –°–µ–∫—Ä–µ—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ–¥–∏–Ω–∞–∫–æ–≤—ã–º –¥–ª—è –≤—Å–µ—Ö –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å–æ–≤!

### 3. –ó–∞–ø—É—Å—Ç–∏—Ç–µ –æ–±–∞ —Å–µ—Ä–≤–µ—Ä–∞

```bash
# –¢–µ—Ä–º–∏–Ω–∞–ª 1: Main Backend
cd backend
go run main.go

# –¢–µ—Ä–º–∏–Ω–∞–ª 2: Admin Backend
cd admin/backend
go run main.go

# –¢–µ—Ä–º–∏–Ω–∞–ª 3: Frontend
cd frontend
npm run dev
```

### 4. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ SSO

1. –û—Ç–∫—Ä–æ–π—Ç–µ http://localhost:3000
2. –í–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É (email/password)
3. –û—Ç–∫—Ä–æ–π—Ç–µ http://localhost:8081/api/admin/auth/me
4. –í—ã –¥–æ–ª–∂–Ω—ã —É–≤–∏–¥–µ—Ç—å –¥–∞–Ω–Ω—ã–µ –∞–¥–º–∏–Ω–∞ –±–µ–∑ –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –≤—Ö–æ–¥–∞!

---

## üîê –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç?

### –°—Ö–µ–º–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏:

```
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—Ö–æ–¥–∏—Ç –Ω–∞ –æ—Å–Ω–æ–≤–Ω–æ–º —Å–∞–π—Ç–µ (localhost:3000)
   ‚Üì
2. Backend —Å–æ–∑–¥–∞–µ—Ç JWT —Ç–æ–∫–µ–Ω —Å roles: ["user", "superadmin"]
   ‚Üì
3. –¢–æ–∫–µ–Ω —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ cookie "auth_token"
   ‚Üì
4. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å (localhost:8081)
   ‚Üì
5. Admin Backend —á–∏—Ç–∞–µ—Ç —Ç–æ—Ç –∂–µ cookie "auth_token"
   ‚Üì
6. –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–∞–ª–∏—á–∏–µ —Ä–æ–ª–∏ "superadmin" –≤ —Ç–æ–∫–µ–Ω–µ
   ‚Üì
7. –ï—Å–ª–∏ –µ—Å—Ç—å - –¥–æ—Å—Ç—É–ø —Ä–∞–∑—Ä–µ—à–µ–Ω, –µ—Å–ª–∏ –Ω–µ—Ç - 403 Forbidden
```

### JWT Token —Å—Ç—Ä—É–∫—Ç—É—Ä–∞:

```json
{
  "user_id": 1,
  "email": "admin@example.com",
  "roles": ["user", "superadmin"],
  "exp": 1234567890,
  "iat": 1234567890
}
```

---

## üìã –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã SSO

### –¢–µ—Å—Ç 1: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–æ–∫–µ–Ω–∞

```bash
# –í–æ–π–¥–∏—Ç–µ –Ω–∞ –æ—Å–Ω–æ–≤–Ω–æ–º —Å–∞–π—Ç–µ, –∑–∞—Ç–µ–º:
curl -b cookies.txt http://localhost:8081/api/admin/auth/me
```

–î–æ–ª–∂–µ–Ω –≤–µ—Ä–Ω—É—Ç—å –¥–∞–Ω–Ω—ã–µ –∞–¥–º–∏–Ω–∞.

### –¢–µ—Å—Ç 2: –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤

```bash
# –í–æ–π–¥–∏—Ç–µ –æ–±—ã—á–Ω—ã–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º (–Ω–µ –∞–¥–º–∏–Ω–æ–º), –∑–∞—Ç–µ–º:
curl -b cookies.txt http://localhost:8081/api/admin/users
```

–î–æ–ª–∂–µ–Ω –≤–µ—Ä–Ω—É—Ç—å 403 Forbidden.

### –¢–µ—Å—Ç 3: –í—ã—Ö–æ–¥ –∏–∑ –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤

```bash
# –í—ã–π–¥–∏—Ç–µ –Ω–∞ –æ—Å–Ω–æ–≤–Ω–æ–º —Å–∞–π—Ç–µ
curl -X POST http://localhost:8080/api/auth/logout

# –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏
curl http://localhost:8081/api/admin/auth/me
```

–î–æ–ª–∂–µ–Ω –≤–µ—Ä–Ω—É—Ç—å 401 Unauthorized.

---

## üõ†Ô∏è –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–æ–ª—è–º–∏

### –î–æ–±–∞–≤–∏—Ç—å —Å—É–ø–µ—Ä–∞–¥–º–∏–Ω–∞

```bash
cd admin/backend
./create-superadmin.sh <user_id>
```

### –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–æ–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

```sql
sqlite3 ../../database/data.db

SELECT u.id, u.name, u.email, a.role
FROM users u
LEFT JOIN admins a ON u.id = a.user_id
WHERE u.id = 1;
```

### –£–¥–∞–ª–∏—Ç—å –ø—Ä–∞–≤–∞ –∞–¥–º–∏–Ω–∞

```sql
sqlite3 ../../database/data.db

DELETE FROM admins WHERE user_id = 1;
```

---

## üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –¥–ª—è Production

### 1. –û–±–Ω–æ–≤–∏—Ç–µ cookie domain

–í `backend/handlers/auth.go` –∏ `admin/backend/handlers/auth.go`:

```go
http.SetCookie(w, &http.Cookie{
    Name:     "auth_token",
    Value:    token,
    Path:     "/",
    Domain:   ".zooplatforma.ru",  // –î–ª—è –≤—Å–µ—Ö –ø–æ–¥–¥–æ–º–µ–Ω–æ–≤
    HttpOnly: true,
    Secure:   true,  // –¢–æ–ª—å–∫–æ HTTPS
    SameSite: http.SameSiteLaxMode,
    MaxAge:   86400 * 7,
})
```

### 2. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å–∏–ª—å–Ω—ã–π JWT_SECRET

```bash
# –°–≥–µ–Ω–µ—Ä–∏—Ä—É–π—Ç–µ —Å–ª—É—á–∞–π–Ω—ã–π —Å–µ–∫—Ä–µ—Ç (–º–∏–Ω–∏–º—É–º 32 —Å–∏–º–≤–æ–ª–∞)
openssl rand -base64 32
```

### 3. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ CORS

–í `admin/backend/main.go`:

```go
allowedOrigins := []string{
    "https://zooplatforma.ru",
    "https://sadmin.zooplatforma.ru",
}
```

---

## üêõ Troubleshooting

### –ü—Ä–æ–±–ª–µ–º–∞: "–ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω" –ø—Ä–∏ –¥–æ—Å—Ç—É–ø–µ –∫ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏

**–†–µ—à–µ–Ω–∏–µ:**
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ JWT_SECRET –æ–¥–∏–Ω–∞–∫–æ–≤—ã–π –≤ –æ–±–æ–∏—Ö .env
2. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤—ã –≤–æ—à–ª–∏ –Ω–∞ –æ—Å–Ω–æ–≤–Ω–æ–º —Å–∞–π—Ç–µ
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ cookie "auth_token" —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω

### –ü—Ä–æ–±–ª–µ–º–∞: "–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω. –¢—Ä–µ–±—É—é—Ç—Å—è –ø—Ä–∞–≤–∞ —Å—É–ø–µ—Ä–∞–¥–º–∏–Ω–∞"

**–†–µ—à–µ–Ω–∏–µ:**
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–æ–±–∞–≤–ª–µ–Ω –≤ —Ç–∞–±–ª–∏—Ü—É admins
2. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Ä–æ–ª—å = 'superadmin'
3. –ü–µ—Ä–µ–ª–æ–≥–∏–Ω—å—Ç–µ—Å—å, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –Ω–æ–≤—ã–π —Ç–æ–∫–µ–Ω —Å —Ä–æ–ª—è–º–∏

### –ü—Ä–æ–±–ª–µ–º–∞: Cookie –Ω–µ –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è –º–µ–∂–¥—É —Å–µ—Ä–≤–∏—Å–∞–º–∏

**–†–µ—à–µ–Ω–∏–µ:**
1. –í localhost —ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ (—Ä–∞–∑–Ω—ã–µ –ø–æ—Ä—Ç—ã)
2. –í production –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø–æ–¥–¥–æ–º–µ–Ω—ã (sadmin.zooplatforma.ru)
3. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ Domain: ".zooplatforma.ru" –≤ cookie

---

## üìö –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è

- –ü–æ–ª–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ SSO: `docs/SSO_ARCHITECTURE.md`
- –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏: `admin/README.md`
- Changelog: `docs/CHANGELOG.md`

---

**–í–µ—Ä—Å–∏—è:** 1.0  
**–î–∞—Ç–∞:** 12 –¥–µ–∫–∞–±—Ä—è 2025
