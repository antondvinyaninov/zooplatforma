# ĞĞ¿Ñ‚Ğ¸Ğ¼Ğ¸Ğ·Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğ¹ multi-stage Dockerfile
# Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµÑ‚ ĞºÑÑˆĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ ÑĞ»Ğ¾ĞµĞ² Ğ´Ğ»Ñ Ğ±Ñ‹ÑÑ‚Ñ€Ğ¾Ğ¹ Ğ¿ĞµÑ€ĞµÑĞ±Ğ¾Ñ€ĞºĞ¸

# ============================================
# Stage 1: Go Dependencies (ĞºÑÑˆĞ¸Ñ€ÑƒĞµÑ‚ÑÑ)
# ============================================
FROM golang:1.25.5-alpine AS go-deps

RUN apk add --no-cache git make build-base

WORKDIR /app

# ĞšĞ¾Ğ¿Ğ¸Ñ€ÑƒĞµĞ¼ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ go.mod/go.sum Ğ´Ğ»Ñ ĞºÑÑˆĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚ĞµĞ¹
COPY database/go.mod database/go.sum ./database/
COPY auth/backend/go.mod auth/backend/go.sum ./auth/backend/
COPY main/backend/go.mod main/backend/go.sum ./main/backend/
COPY admin/backend/go.mod admin/backend/go.sum ./admin/backend/
COPY clinic/backend/go.mod clinic/backend/go.sum ./clinic/backend/
COPY owner/backend/go.mod owner/backend/go.sum ./owner/backend/
COPY petbase/backend/go.mod petbase/backend/go.sum ./petbase/backend/
COPY shelter/backend/go.mod shelter/backend/go.sum ./shelter/backend/
COPY volunteer/backend/go.mod volunteer/backend/go.sum ./volunteer/backend/
COPY pkg ./pkg

# Ğ¡ĞºĞ°Ñ‡Ğ¸Ğ²Ğ°ĞµĞ¼ Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚Ğ¸ (ÑÑ‚Ğ¾Ñ‚ ÑĞ»Ğ¾Ğ¹ ĞºÑÑˆĞ¸Ñ€ÑƒĞµÑ‚ÑÑ)
RUN go mod download -C database && \
    go mod download -C auth/backend && \
    go mod download -C main/backend && \
    go mod download -C admin/backend && \
    go mod download -C clinic/backend && \
    go mod download -C owner/backend && \
    go mod download -C petbase/backend && \
    go mod download -C shelter/backend && \
    go mod download -C volunteer/backend

# ============================================
# Stage 2: Go Builder (Ğ¿ĞµÑ€ĞµÑĞ¾Ğ±Ğ¸Ñ€Ğ°ĞµÑ‚ÑÑ Ğ¿Ñ€Ğ¸ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğ¸ ĞºĞ¾Ğ´Ğ°)
# ============================================
FROM go-deps AS go-builder

# ĞšĞ¾Ğ¿Ğ¸Ñ€ÑƒĞµĞ¼ Ğ²ĞµÑÑŒ ĞºĞ¾Ğ´
COPY . .

# Ğ¡Ğ¾Ğ±Ğ¸Ñ€Ğ°ĞµĞ¼ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ½ÑƒĞ¶Ğ½Ñ‹Ğ¹ ÑĞµÑ€Ğ²Ğ¸Ñ (Ñ‡ĞµÑ€ĞµĞ· ARG)
ARG SERVICE=main
RUN case $SERVICE in \
    auth) cd auth/backend && CGO_ENABLED=1 go build -o /app/bin/backend . ;; \
    main) cd main/backend && go build -o /app/bin/backend . ;; \
    admin) cd admin/backend && go build -o /app/bin/backend . ;; \
    clinic) cd clinic/backend && go build -o /app/bin/backend . ;; \
    owner) cd owner/backend && go build -o /app/bin/backend . ;; \
    petbase) cd petbase/backend && go build -o /app/bin/backend . ;; \
    shelter) cd shelter/backend && go build -o /app/bin/backend . ;; \
    volunteer) cd volunteer/backend && go build -o /app/bin/backend . ;; \
    *) echo "Unknown service: $SERVICE" && exit 1 ;; \
    esac

# ============================================
# Stage 3: Node Dependencies (ĞºÑÑˆĞ¸Ñ€ÑƒĞµÑ‚ÑÑ)
# ============================================
FROM node:20-alpine AS node-deps

WORKDIR /app

# ĞšĞ¾Ğ¿Ğ¸Ñ€ÑƒĞµĞ¼ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ package.json Ğ´Ğ»Ñ ĞºÑÑˆĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ
COPY main/frontend/package*.json ./main/frontend/
COPY shared/package*.json ./shared/

# Ğ£ÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚Ğ¸ (ÑÑ‚Ğ¾Ñ‚ ÑĞ»Ğ¾Ğ¹ ĞºÑÑˆĞ¸Ñ€ÑƒĞµÑ‚ÑÑ)
RUN cd main/frontend && npm ci && \
    cd ../.. && cd shared && npm ci

# ============================================
# Stage 4: Next.js Builder (Ğ¿ĞµÑ€ĞµÑĞ¾Ğ±Ğ¸Ñ€Ğ°ĞµÑ‚ÑÑ Ğ¿Ñ€Ğ¸ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğ¸ ĞºĞ¾Ğ´Ğ°)
# ============================================
FROM node-deps AS next-builder

# ĞšĞ¾Ğ¿Ğ¸Ñ€ÑƒĞµĞ¼ Ğ²ĞµÑÑŒ ĞºĞ¾Ğ´
COPY main/frontend ./main/frontend
COPY shared ./shared

# Ğ¡Ğ¾Ğ±Ğ¸Ñ€Ğ°ĞµĞ¼ Next.js
RUN cd main/frontend && npm run build

# ============================================
# Stage 5: Runtime (Ğ¼Ğ¸Ğ½Ğ¸Ğ¼Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¹ Ğ¾Ğ±Ñ€Ğ°Ğ·)
# ============================================
FROM alpine:3.19 AS runtime

RUN apk add --no-cache ca-certificates nodejs npm

WORKDIR /app

# ĞšĞ¾Ğ¿Ğ¸Ñ€ÑƒĞµĞ¼ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ½ÑƒĞ¶Ğ½Ñ‹Ğµ Ñ„Ğ°Ğ¹Ğ»Ñ‹
ARG SERVICE=main

# Ğ”Ğ»Ñ Ğ²ÑĞµÑ… ÑĞµÑ€Ğ²Ğ¸ÑĞ¾Ğ² ĞºĞ¾Ğ¿Ğ¸Ñ€ÑƒĞµĞ¼ Go Ğ±Ğ¸Ğ½Ğ°Ñ€Ğ½Ğ¸Ğº
COPY --from=go-builder /app/bin/backend /app/backend

# Ğ”Ğ»Ñ main ÑĞµÑ€Ğ²Ğ¸ÑĞ° ĞºĞ¾Ğ¿Ğ¸Ñ€ÑƒĞµĞ¼ Next.js
RUN if [ "$SERVICE" = "main" ]; then \
    mkdir -p /app/frontend; \
    fi

COPY --from=next-builder /app/main/frontend/.next /app/frontend/.next
COPY --from=next-builder /app/main/frontend/node_modules /app/frontend/node_modules
COPY --from=next-builder /app/main/frontend/package.json /app/frontend/package.json
COPY --from=next-builder /app/main/frontend/public /app/frontend/public
COPY --from=next-builder /app/main/frontend/next.config.ts /app/frontend/next.config.ts

# ĞšĞ¾Ğ¿Ğ¸Ñ€ÑƒĞµĞ¼ Ğ¼Ğ¸Ğ³Ñ€Ğ°Ñ†Ğ¸Ğ¸
COPY database/migrations /app/migrations

# Ğ¡ĞºÑ€Ğ¸Ğ¿Ñ‚ Ğ·Ğ°Ğ¿ÑƒÑĞºĞ°
RUN cat > /app/start.sh << 'EOF'
#!/bin/sh
set -e

SERVICE=${SERVICE:-main}

if [ "$SERVICE" = "main" ]; then
    echo "ğŸš€ Starting Main Backend..."
    /app/backend &
    BACKEND_PID=$!
    
    echo "ğŸš€ Starting Main Frontend..."
    cd /app/frontend && npm start &
    FRONTEND_PID=$!
    
    wait -n
else
    echo "ğŸš€ Starting $SERVICE Backend..."
    exec /app/backend
fi
EOF
RUN chmod +x /app/start.sh

EXPOSE 7100 8000 8100 8200 8400 8500 8600 9000 3000

CMD ["/app/start.sh"]
