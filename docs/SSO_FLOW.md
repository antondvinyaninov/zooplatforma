# SSO Flow Diagram

Визуальная схема работы Single Sign-On в ЗооПлатформе.

---

## 🔄 Полный цикл авторизации

```
┌─────────────────────────────────────────────────────────────────┐
│                         ПОЛЬЗОВАТЕЛЬ                             │
└────────────────────────┬────────────────────────────────────────┘
                         │
                         │ 1. Открывает zooplatforma.ru
                         ▼
┌─────────────────────────────────────────────────────────────────┐
│                    FRONTEND (localhost:3000)                     │
│                                                                  │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │  Форма входа: email + password                           │  │
│  └──────────────────────────────────────────────────────────┘  │
└────────────────────────┬────────────────────────────────────────┘
                         │
                         │ 2. POST /api/auth/login
                         │    {email, password}
                         ▼
┌─────────────────────────────────────────────────────────────────┐
│                  MAIN BACKEND (localhost:8080)                   │
│                                                                  │
│  1. Проверяет credentials                                       │
│  2. Получает роли из таблицы admins                             │
│  3. Генерирует JWT токен:                                       │
│     {                                                            │
│       user_id: 1,                                               │
│       email: "user@example.com",                                │
│       roles: ["user", "superadmin"]  ← ВАЖНО!                  │
│     }                                                            │
│  4. Устанавливает cookie:                                       │
│     Set-Cookie: auth_token=<JWT>                                │
│                 Domain=.zooplatforma.ru                         │
│                 HttpOnly=true                                   │
│                                                                  │
└────────────────────────┬────────────────────────────────────────┘
                         │
                         │ 3. Cookie установлен
                         ▼
┌─────────────────────────────────────────────────────────────────┐
│                    FRONTEND (localhost:3000)                     │
│                                                                  │
│  ✅ Пользователь авторизован                                    │
│  Cookie: auth_token=<JWT>                                       │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘


═══════════════════════════════════════════════════════════════════
                    ПЕРЕХОД НА АДМИН-ПАНЕЛЬ
═══════════════════════════════════════════════════════════════════


┌─────────────────────────────────────────────────────────────────┐
│                         ПОЛЬЗОВАТЕЛЬ                             │
└────────────────────────┬────────────────────────────────────────┘
                         │
                         │ 4. Открывает sadmin.zooplatforma.ru
                         │    Cookie автоматически передается!
                         ▼
┌─────────────────────────────────────────────────────────────────┐
│                 ADMIN FRONTEND (localhost:3001)                  │
│                                                                  │
│  Cookie: auth_token=<JWT>  ← Тот же токен!                     │
│                                                                  │
└────────────────────────┬────────────────────────────────────────┘
                         │
                         │ 5. GET /api/admin/auth/me
                         │    Cookie: auth_token=<JWT>
                         ▼
┌─────────────────────────────────────────────────────────────────┐
│                 ADMIN BACKEND (localhost:8081)                   │
│                                                                  │
│  1. Читает cookie auth_token                                    │
│  2. Парсит JWT токен                                            │
│  3. Проверяет подпись (общий JWT_SECRET)                        │
│  4. Извлекает roles: ["user", "superadmin"]                     │
│  5. Проверяет наличие роли "superadmin"                         │
│  6. ✅ Доступ разрешен!                                         │
│                                                                  │
└────────────────────────┬────────────────────────────────────────┘
                         │
                         │ 6. Данные админа
                         ▼
┌─────────────────────────────────────────────────────────────────┐
│                 ADMIN FRONTEND (localhost:3001)                  │
│                                                                  │
│  ✅ Админ-панель доступна                                       │
│  Пользователь может управлять платформой                        │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘


═══════════════════════════════════════════════════════════════════
                           ВЫХОД
═══════════════════════════════════════════════════════════════════


┌─────────────────────────────────────────────────────────────────┐
│                         ПОЛЬЗОВАТЕЛЬ                             │
└────────────────────────┬────────────────────────────────────────┘
                         │
                         │ 7. Нажимает "Выйти" на любом сервисе
                         ▼
┌─────────────────────────────────────────────────────────────────┐
│              ЛЮБОЙ BACKEND (8080 или 8081)                       │
│                                                                  │
│  POST /api/auth/logout                                          │
│                                                                  │
│  Set-Cookie: auth_token=                                        │
│              Domain=.zooplatforma.ru                            │
│              MaxAge=-1  ← Удаляет cookie                        │
│                                                                  │
└────────────────────────┬────────────────────────────────────────┘
                         │
                         │ 8. Cookie удален
                         ▼
┌─────────────────────────────────────────────────────────────────┐
│                    ВСЕ СЕРВИСЫ                                   │
│                                                                  │
│  ❌ Пользователь разлогинен везде                               │
│  Нужно войти заново                                             │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 🔑 Ключевые моменты

### 1. Общий JWT токен
- Один токен для всех сервисов
- Хранится в cookie `auth_token`
- Содержит роли пользователя

### 2. Общий JWT_SECRET
- Все микросервисы используют один секрет
- Позволяет проверять токены независимо
- Должен быть одинаковым в `.env` всех сервисов

### 3. Cookie Domain
```javascript
// Localhost (разработка)
Domain: ""  // Пустой, работает только на одном домене

// Production
Domain: ".zooplatforma.ru"  // Доступен всем поддоменам
```

### 4. Роли в JWT
```json
{
  "user_id": 1,
  "email": "admin@example.com",
  "roles": ["user", "superadmin"],  // ← Определяют доступ
  "exp": 1234567890
}
```

---

## 🚫 Что НЕ работает без SSO

### Без SSO (старый подход):
```
1. Вход на основном сайте → токен A
2. Переход на админ-панель → нужен новый вход → токен B
3. Два разных токена, два разных входа
4. Выход на одном сайте → на другом все еще авторизован
```

### С SSO (текущий подход):
```
1. Вход на основном сайте → токен A
2. Переход на админ-панель → тот же токен A
3. Один токен, один вход
4. Выход на любом сайте → разлогинен везде
```

---

## 🔒 Безопасность

### Защита токена:
- ✅ HttpOnly cookie (защита от XSS)
- ✅ Secure flag в production (только HTTPS)
- ✅ SameSite=Lax (защита от CSRF)
- ✅ Короткий срок жизни (7 дней)

### Проверка прав:
- ✅ Каждый запрос проверяет токен
- ✅ Middleware проверяет роли
- ✅ Логирование всех действий админов
- ✅ IP адрес в логах

---

## 📊 Преимущества SSO

1. **Удобство для пользователей**
   - Один раз вошел → доступ ко всем сервисам
   - Не нужно запоминать несколько паролей

2. **Безопасность**
   - Централизованная авторизация
   - Единая точка контроля доступа
   - Выход из всех сервисов одновременно

3. **Масштабируемость**
   - Легко добавлять новые микросервисы
   - Не нужно дублировать логику авторизации
   - Общая система управления правами

4. **Аудит**
   - Все действия логируются
   - Единая система отслеживания
   - Легко найти, кто что делал

---

## 🔮 Будущие улучшения

### v0.2.0:
- Refresh tokens (автоматическое обновление)
- 2FA (двухфакторная аутентификация)
- OAuth2 (вход через соцсети)

### v1.0.0:
- Отдельный Auth Service
- Redis для сессий
- Rate limiting
- Мониторинг и алерты

---

**Версия:** 1.0  
**Дата:** 12 декабря 2025
