# SSO ะััะธัะตะบัััะฐ ะะพะพะะปะฐััะพัะผั

Single Sign-On ัะธััะตะผะฐ ะดะปั ะฒัะตั ะผะธะบัะพัะตัะฒะธัะพะฒ ะฟะปะฐััะพัะผั.

---

## ๐ฏ ะฆะตะปั

ะะดะธะฝะฐั ัะธััะตะผะฐ ะฐะฒัะพัะธะทะฐัะธะธ ะดะปั ะฒัะตั ัะตัะฒะธัะพะฒ:
- ะัะฝะพะฒะฝะพะต ะฟัะธะปะพะถะตะฝะธะต (`zooplatforma.ru`)
- ะะดะผะธะฝ-ะฟะฐะฝะตะปั (`sadmin.zooplatforma.ru`)
- ะะฝะฐะปะธัะธะบะฐ (`analytics.zooplatforma.ru`)
- ะัะดััะธะต ะผะธะบัะพัะตัะฒะธัั

---

## ๐๏ธ ะััะธัะตะบัััะฐ

### ะขะตะบััะฐั ัะตะฐะปะธะทะฐัะธั: Auth Service SSO

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ              Auth Service (ะฆะตะฝัั ะฐะฒัะพัะธะทะฐัะธะธ)                โ
โ                   auth/backend:7100                          โ
โ                                                              โ
โ  POST /api/auth/login    โ ะัะดะฐะตั JWT ะฒ cookie              โ
โ  POST /api/auth/logout   โ ะฃะดะฐะปัะตั cookie                   โ
โ  GET  /api/auth/me       โ ะัะพะฒะตััะตั ัะพะบะตะฝ                  โ
โ  GET  /api/auth/verify   โ ะัะฑะปะธัะฝะฐั ะฟัะพะฒะตัะบะฐ ัะพะบะตะฝะฐ        โ
โ                                                              โ
โ  Cookie: auth_token                                          โ
โ  Domain: .zooplatforma.ru (ะดะพัััะฟะตะฝ ะฒัะตะผ ะฟะพะดะดะพะผะตะฝะฐะผ)        โ
โ  ะะฐะทะฐ ะดะฐะฝะฝัั: auth/backend/auth.db                          โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                            โ
                            โ Shared JWT Token
            โโโโโโโโโโโโโโโโโผโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโ
            โ               โ               โ               โ
            โผ               โผ               โผ               โผ
    โโโโโโโโโโโโโโโโ โโโโโโโโโโโโโโโโ โโโโโโโโโโโโโโโโ โโโโโโโโโโโโโโโโ
    โ   Main       โ โ  Admin Panel โ โ   PetBase    โ โ   Owner      โ
    โ   :3000      โ โ    :4000     โ โ    :4100     โ โ    :6100     โ
    โ              โ โ              โ โ              โ โ              โ
    โ ะงะธัะฐะตั       โ โ ะงะธัะฐะตั       โ โ ะงะธัะฐะตั       โ โ ะงะธัะฐะตั       โ
    โ auth_token   โ โ auth_token   โ โ auth_token   โ โ auth_token   โ
    โโโโโโโโโโโโโโโโ โโโโโโโโโโโโโโโโ โโโโโโโโโโโโโโโโ โโโโโโโโโโโโโโโโ
            โ               โ               โ               โ
            โผ               โผ               โผ               โผ
    โโโโโโโโโโโโโโโโ โโโโโโโโโโโโโโโโ โโโโโโโโโโโโโโโโ โโโโโโโโโโโโโโโโ
    โ Main Backend โ โAdmin Backend โ โPetBase API   โ โOwner Backend โ
    โ   :8000      โ โ    :9000     โ โ    :8100     โ โ    :8400     โ
    โ              โ โ              โ โ              โ โ              โ
    โ ะัะพะฒะตััะตั    โ โ ะัะพะฒะตััะตั    โ โ ะัะพะฒะตััะตั    โ โ ะัะพะฒะตััะตั    โ
    โ ัะตัะตะท Auth   โ โ ัะตัะตะท Auth + โ โ ัะตัะตะท Auth   โ โ ัะตัะตะท Auth   โ
    โ Service      โ โ ะฟัะฐะฒะฐ ะฐะดะผะธะฝะฐ โ โ Service      โ โ Service      โ
    โโโโโโโโโโโโโโโโ โโโโโโโโโโโโโโโโ โโโโโโโโโโโโโโโโ โโโโโโโโโโโโโโโโ
                            โ
                            โผ
                    โโโโโโโโโโโโโโโโ
                    โ Auth Service โ
                    โ   :7100      โ
                    โ              โ
                    โ ะัะพะฒะตัะบะฐ JWT โ
                    โ ะฃะฟัะฐะฒะปะตะฝะธะต   โ
                    โ ะฟะพะปัะทะพะฒะฐัะตะปัะผะธโ
                    โโโโโโโโโโโโโโโโ
```

---

## ๐ JWT Token Structure

```json
{
  "user_id": 1,
  "email": "user@example.com",
  "roles": ["user", "superadmin"],
  "permissions": ["read", "write", "admin"],
  "exp": 1234567890,
  "iat": 1234567890
}
```

**ะะฐะถะฝะพ:**
- `roles` - ะผะฐััะธะฒ ัะพะปะตะน ะฟะพะปัะทะพะฒะฐัะตะปั
- `permissions` - ะดะตัะฐะปัะฝัะต ะฟัะฐะฒะฐ
- ะขะพะบะตะฝ ะฟะพะดะฟะธัะฐะฝ ะพะฑัะธะผ `JWT_SECRET`

---

## ๐ ะัะพัะตัั ะฐะฒัะพัะธะทะฐัะธะธ

### 1. ะัะพะด ะฟะพะปัะทะพะฒะฐัะตะปั

```
User โ Frontend (zooplatforma.ru)
  โ
POST /api/auth/login
  โ
Auth Service (7100) ะฟัะพะฒะตััะตั credentials
  โ
ะะตะฝะตัะธััะตั JWT ัะพะบะตะฝ
  โ
Set-Cookie: auth_token=<JWT>
  Domain: .zooplatforma.ru
  HttpOnly: true
  Secure: true (ะฒ production)
  SameSite: Lax
  โ
Frontend ะฟะพะปััะฐะตั ัะพะบะตะฝ ะฒ cookie
```

**โ๏ธ ะะะะะ:** Main Backend (8000) ะะ ะฟัะพะฒะตััะตั ะฐะฒัะพัะธะทะฐัะธั! ะัะต ะฟัะพะฒะตัะบะธ ะธะดัั ัะตัะตะท Auth Service (7100).

### 2. ะะพัััะฟ ะบ ะฐะดะผะธะฝ-ะฟะฐะฝะตะปะธ

```
User โ Admin Frontend (sadmin.zooplatforma.ru)
  โ
ะงะธัะฐะตั cookie auth_token (ะดะพัััะฟะตะฝ ะฑะปะฐะณะพะดะฐัั .zooplatforma.ru)
  โ
GET /api/admin/auth/me
  โ
Admin Backend (9000) โ Auth Service (7100):
  1. ะขะพะบะตะฝ ะฒะฐะปะธะดะตะฝ?
  2. ะะพะปัะทะพะฒะฐัะตะปั ัััะตััะฒัะตั?
  3. ะััั ัะพะปั superadmin?
  โ
ะัะปะธ ะฒัะต ะะ โ ะดะพัััะฟ ัะฐะทัะตัะตะฝ
ะัะปะธ ะฝะตั โ ัะตะดะธัะตะบั ะฝะฐ zooplatforma.ru/auth
```

### 3. ะัะพะฒะตัะบะฐ ัะพะบะตะฝะฐ ะฒ ะผะธะบัะพัะตัะฒะธัะฐั

ะะฐะถะดัะน ะผะธะบัะพัะตัะฒะธั (Main, PetBase, Owner, Clinic ะธ ั.ะด.):
1. ะงะธัะฐะตั cookie `auth_token` ะธะปะธ Authorization header
2. ะัะฟัะฐะฒะปัะตั ะทะฐะฟัะพั ะบ Auth Service (7100) `/api/auth/me`
3. Auth Service ะฟัะพะฒะตััะตั JWT ะธ ะฒะพะทะฒัะฐัะฐะตั ะดะฐะฝะฝัะต ะฟะพะปัะทะพะฒะฐัะตะปั
4. ะะธะบัะพัะตัะฒะธั ะฟะพะปััะฐะตั userID, email, role
5. ะะพะฑะฐะฒะปัะตั ะดะฐะฝะฝัะต ะฒ ะบะพะฝัะตะบัั ะทะฐะฟัะพัะฐ

**ะัะต ะผะธะบัะพัะตัะฒะธัั ะธัะฟะพะปัะทััั `pkg/middleware/auth.go` ะบะพัะพััะน ะพะฑัะฐัะฐะตััั ะบ Auth Service (7100).**

---

## ๐ก API ะดะปั SSO

### Auth Service (ะฟะพัั 7100)

#### POST /api/auth/login
ะัะพะด ะฟะพะปัะทะพะฒะฐัะตะปั.

**Request:**
```json
{
  "email": "user@example.com",
  "password": "password123"
}
```

**Response:**
```json
{
  "success": true,
  "data": {
    "user": {
      "id": 1,
      "name": "User Name",
      "email": "user@example.com",
      "role": "user"
    },
    "token": "eyJhbGciOiJIUzI1NiIs..."
  }
}
```

**Cookie:**
```
Set-Cookie: auth_token=<JWT>; Domain=.zooplatforma.ru; HttpOnly; Secure; SameSite=Lax; Max-Age=604800
```

#### GET /api/auth/me
ะะพะปััะธัั ัะตะบััะตะณะพ ะฟะพะปัะทะพะฒะฐัะตะปั (ะธัะฟะพะปัะทัะตััั ะดะปั SSO).

**Headers:**
```
Authorization: Bearer <token>
```
ะธะปะธ
```
Cookie: auth_token=<JWT>
```

**Response:**
```json
{
  "success": true,
  "data": {
    "user": {
      "id": 1,
      "email": "user@example.com",
      "name": "ะะฒะฐะฝ",
      "last_name": "ะะฒะฐะฝะพะฒ",
      "role": "user",
      "avatar": "/uploads/users/1/avatar.jpg"
    },
    "token": "eyJhbGciOiJIUzI1NiIs..."
  }
}
```

#### GET /api/auth/verify
ะัะฑะปะธัะฝะฐั ะฟัะพะฒะตัะบะฐ ัะพะบะตะฝะฐ (ะดะปั ะผะธะบัะพัะตัะฒะธัะพะฒ).

**Request:**
```
Cookie: auth_token=<JWT>
```

**Response:**
```json
{
  "success": true,
  "data": {
    "user_id": 1,
    "email": "user@example.com",
    "role": "user",
    "valid": true
  }
}
```

#### POST /api/auth/logout
ะััะพะด ะธะท ะฒัะตั ัะตัะฒะธัะพะฒ.

**Response:**
```
Set-Cookie: auth_token=; Domain=.zooplatforma.ru; Max-Age=0
```

---

## ๐ก๏ธ ะะตะทะพะฟะฐัะฝะพััั

### 1. JWT Secret
- ะะฑัะธะน ะดะปั Auth Service ะธ ะฒัะตั ะผะธะบัะพัะตัะฒะธัะพะฒ
- ะฅัะฐะฝะธััั ะฒ `.env` ะบะฐะถะดะพะณะพ ัะตัะฒะธัะฐ
- ะะธะฝะธะผัะผ 32 ัะธะผะฒะพะปะฐ
- ะะตะณัะปััะฝะฐั ัะพัะฐัะธั (ัะฐะท ะฒ 3 ะผะตัััะฐ)

### 2. Cookie ะฝะฐัััะพะนะบะธ
```javascript
{
  Domain: '.zooplatforma.ru',  // ะะพัััะฟะตะฝ ะฒัะตะผ ะฟะพะดะดะพะผะตะฝะฐะผ
  HttpOnly: true,               // ะะฐัะธัะฐ ะพั XSS
  Secure: true,                 // ะขะพะปัะบะพ HTTPS (production)
  SameSite: 'Lax',             // ะะฐัะธัะฐ ะพั CSRF
  MaxAge: 604800               // 7 ะดะฝะตะน
}
```

### 3. ะัะพะฒะตัะบะฐ ะฟัะฐะฒ
Auth Service ะฟัะพะฒะตััะตั:
- ะขะพะบะตะฝ ะฒะฐะปะธะดะตะฝ
- ะกัะพะบ ะฝะต ะธััะตะบ
- ะะพะปัะทะพะฒะฐัะตะปั ัััะตััะฒัะตั
- ะััั ะฝัะถะฝัะต ะฟัะฐะฒะฐ (role)

ะะธะบัะพัะตัะฒะธัั ะฟะพะปััะฐัั ัะถะต ะฟัะพะฒะตัะตะฝะฝัะต ะดะฐะฝะฝัะต ะพั Auth Service.

### 4. ะะพะณะธัะพะฒะฐะฝะธะต
- ะัะต ะฒัะพะดั ะปะพะณะธัััััั ะฒ Auth Service
- ะัะต ะฟัะพะฒะตัะบะธ ัะพะบะตะฝะพะฒ ะปะพะณะธัััััั
- ะะพะดะพะทัะธัะตะปัะฝะฐั ะฐะบัะธะฒะฝะพััั โ ะฐะปะตััั

### 5. ะฆะตะฝััะฐะปะธะทะพะฒะฐะฝะฝะฐั ะฐะฒัะพัะธะทะฐัะธั
**Main Backend (8000) ะะ ะฟัะพะฒะตััะตั ัะพะบะตะฝั!**
- ะัะต ะฟัะพะฒะตัะบะธ ะธะดัั ัะตัะตะท Auth Service (7100)
- Main Backend ะธัะฟะพะปัะทัะตั `pkg/middleware/auth.go`
- Main Backend ะฟะพะปััะฐะตั userID ะธะท ะบะพะฝัะตะบััะฐ ะฟะพัะปะต ะฟัะพะฒะตัะบะธ Auth Service

---

## ๐ง ะะตะฐะปะธะทะฐัะธั

### 1. Auth Service (auth/backend)

**ะฃะถะต ัะตะฐะปะธะทะพะฒะฐะฝ:**
- โ ะะตะณะธัััะฐัะธั ะธ ะฒัะพะด ะฟะพะปัะทะพะฒะฐัะตะปะตะน
- โ ะะตะฝะตัะฐัะธั JWT ัะพะบะตะฝะพะฒ
- โ ะัะพะฒะตัะบะฐ ัะพะบะตะฝะพะฒ ัะตัะตะท `/api/auth/me`
- โ ะฃะฟัะฐะฒะปะตะฝะธะต ัะตััะธัะผะธ
- โ ะกะพะฑััะฒะตะฝะฝะฐั ะฑะฐะทะฐ ะดะฐะฝะฝัั `auth.db`

**ะะพัั:** 7100  
**ะะฐะทะฐ ะดะฐะฝะฝัั:** `auth/backend/auth.db`  
**JWT Secret:** ะะฑัะธะน ะดะปั ะฒัะตั ัะตัะฒะธัะพะฒ

### 2. Middleware ะดะปั ะผะธะบัะพัะตัะฒะธัะพะฒ (pkg/middleware)

**ะคะฐะนะป:** `pkg/middleware/auth.go`

**ะคัะฝะบัะธะธ:**
- `AuthMiddleware` - ะฟัะพะฒะตัะบะฐ ัะพะบะตะฝะฐ ัะตัะตะท Auth Service
- `OptionalAuthMiddleware` - ะพะฟัะธะพะฝะฐะปัะฝะฐั ะฟัะพะฒะตัะบะฐ
- `VerifyTokenViaAuthService` - ะฟัะพะฒะตัะบะฐ ัะพะบะตะฝะฐ
- `LoginViaAuthService` - ะฒัะพะด ัะตัะตะท Auth Service

**ะัะฟะพะปัะทะพะฒะฐะฝะธะต:**

```go
// clinic/backend/main.go
import pkgmiddleware "github.com/zooplatforma/pkg/middleware"

// ะะฐัะธัะตะฝะฝัะต ัะพััั
router.Handle("/api/pets", pkgmiddleware.AuthMiddleware(http.HandlerFunc(handlers.GetPets))).Methods("GET")
```

**ะะตัะตะผะตะฝะฝะฐั ะพะบััะถะตะฝะธั:**
```bash
AUTH_SERVICE_URL=http://localhost:7100
```

### 3. ะะฑะฝะพะฒะธัั ะผะธะบัะพัะตัะฒะธัั

ะัะต ะผะธะบัะพัะตัะฒะธัั ะธัะฟะพะปัะทััั `pkg/middleware/auth.go`:
- โ Main Backend (8000)
- โ Admin Backend (9000)
- โ PetBase Backend (8100)
- โ Shelter Backend (8200)
- โ Owner Backend (8400)
- โ Volunteer Backend (8500)
- โ Clinic Backend (8600)

**ะะฐะถะดัะน ะผะธะบัะพัะตัะฒะธั:**
1. ะะผะฟะพััะธััะตั `pkg/middleware`
2. ะัะธะผะตะฝัะตั `AuthMiddleware` ะบ ะทะฐัะธัะตะฝะฝัะผ ัะพััะฐะผ
3. ะะพะปััะฐะตั `userID` ะธะท ะบะพะฝัะตะบััะฐ ัะตัะตะท `pkgmiddleware.GetUserID(r)`

---

## ๐ ะขะตะบััะธะน ััะฐััั

### โ ะะตะฐะปะธะทะพะฒะฐะฝะพ

- Auth Service (ะฟะพัั 7100) ัะฐะฑะพัะฐะตั
- ะัะต ะผะธะบัะพัะตัะฒะธัั ะธัะฟะพะปัะทััั `pkg/middleware/auth.go`
- ะัะพะฒะตัะบะฐ ัะพะบะตะฝะพะฒ ัะตัะตะท Auth Service API
- ะะดะธะฝัะน JWT Secret ะดะปั ะฒัะตั ัะตัะฒะธัะพะฒ
- Cookie `auth_token` ั domain `.zooplatforma.ru`

### ๐ ะััะธัะตะบัััะฐ

```
User โ Frontend โ Auth Service (7100)
                      โ
                  JWT Token
                      โ
        โโโโโโโโโโโโโโโดโโโโโโโโโโโโโโ
        โ                           โ
  ะะธะบัะพัะตัะฒะธัั              pkg/middleware
  (Main, Admin,              AuthMiddleware
   PetBase, Owner,                โ
   Clinic, etc.)          ะัะพะฒะตัะบะฐ ัะตัะตะท
        โ                  Auth Service API
   ะะพะปััะฐัั userID              โ
   ะธะท ะบะพะฝัะตะบััะฐ            ะะพะทะฒัะฐั User
```

### ๐ ะะปััะตะฒัะต ะบะพะผะฟะพะฝะตะฝัั

1. **Auth Service (7100)** - ะตะดะธะฝะฐั ัะพัะบะฐ ะฐะฒัะพัะธะทะฐัะธะธ
2. **pkg/middleware** - ะพะฑัะธะน middleware ะดะปั ะฒัะตั ัะตัะฒะธัะพะฒ
3. **JWT Token** - ะฟะตัะตะดะฐะตััั ัะตัะตะท cookie ะธะปะธ Authorization header
4. **Context** - userID, email, role ะดะพัััะฟะฝั ะฒ handlers

---

## ๐ ะัะตะธะผััะตััะฒะฐ ัะตะบััะตะน ะฐััะธัะตะบัััั

โ **ะะดะธะฝะฐั ะฐะฒัะพัะธะทะฐัะธั** - Auth Service ะบะฐะบ ะตะดะธะฝะฐั ัะพัะบะฐ ะฒัะพะดะฐ  
โ **ะะตะทะพะฟะฐัะฝะพััั** - HttpOnly cookies, ัะตะฝััะฐะปะธะทะพะฒะฐะฝะฝะฐั ะฟัะพะฒะตัะบะฐ  
โ **ะัะพััะพัะฐ** - ะฒัะต ะผะธะบัะพัะตัะฒะธัั ะธัะฟะพะปัะทััั ะพะดะธะฝ middleware  
โ **ะะฐัััะฐะฑะธััะตะผะพััั** - ะปะตะณะบะพ ะดะพะฑะฐะฒะปััั ะฝะพะฒัะต ะผะธะบัะพัะตัะฒะธัั  
โ **ะัะดะธั** - ะฒัะต ะดะตะนััะฒะธั ะปะพะณะธัััััั ะฒ Auth Service  
โ **ะะทะพะปััะธั** - Auth Service ะธะผะตะตั ัะฒะพั ะะ `auth.db`

---

## ๐ฎ ะัะดััะธะต ัะปัััะตะฝะธั

### Refresh Tokens
- ะะพัะพัะบะธะน access token (15 ะผะธะฝัั)
- ะะปะธะฝะฝัะน refresh token (7 ะดะฝะตะน)
- ะะฒัะพะผะฐัะธัะตัะบะพะต ะพะฑะฝะพะฒะปะตะฝะธะต

### OAuth2 / OpenID Connect
- ะัะพะด ัะตัะตะท ัะพััะตัะธ (VK, Google)
- API ะดะปั ััะพัะพะฝะฝะธั ะฟัะธะปะพะถะตะฝะธะน
- Scope ะธ permissions

### Rate Limiting
- ะะฐัะธัะฐ ะพั brute force
- ะะธะผะธัั ะฝะฐ ะบะพะปะธัะตััะฒะพ ะทะฐะฟัะพัะพะฒ
- IP ะฑะปะพะบะธัะพะฒะบะฐ

### ะะพะฝะธัะพัะธะฝะณ
- ะะพะณะธัะพะฒะฐะฝะธะต ะฒัะตั ะฒัะพะดะพะฒ
- ะะปะตััั ะฝะฐ ะฟะพะดะพะทัะธัะตะปัะฝัั ะฐะบัะธะฒะฝะพััั
- ะะตััะธะบะธ ะฟัะพะธะทะฒะพะดะธัะตะปัะฝะพััะธ

---

**ะะตััะธั:** 2.0  
**ะะฐัะฐ:** 29 ัะฝะฒะฐัั 2025  
**ะกัะฐััั:** ะะตะฐะปะธะทะพะฒะฐะฝะพ (Auth Service ะฐะบัะธะฒะตะฝ)
