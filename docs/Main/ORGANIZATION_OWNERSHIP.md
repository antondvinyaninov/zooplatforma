# Система владения организациями

## Описание

Реализована система владения организациями с двумя сценариями создания:

1. **Представитель организации** - пользователь создает организацию и становится её владельцем (owner)
2. **Публичная информация** - пользователь добавляет организацию без владельца (просто информация)

## Функциональность

### 1. Создание организации

При создании организации есть чекбокс "Я представитель этой организации":

- **Если отмечен** → пользователь становится owner с полными правами
- **Если не отмечен** → организация создается без владельца (публичная информация)

**Файлы:**
- `frontend/app/(main)/org/create/page.tsx` - форма создания с чекбоксом
- `backend/handlers/organizations.go` - `CreateOrganizationHandler` обрабатывает флаг `is_representative`

### 2. Заявка на владение

Если у организации нет владельца, любой авторизованный пользователь может заявить о владении:

**Условия:**
- Организация существует
- У организации нет owner
- Пользователь не является участником организации

**Процесс:**
1. На странице организации показывается блок "Владелец не найден"
2. Кнопка "Я владелец"
3. После подтверждения пользователь становится owner с полными правами

**Файлы:**
- `frontend/app/(main)/org/[id]/page.tsx` - кнопка "Я владелец"
- `frontend/lib/organizations-api.ts` - метод `claimOwnership()`
- `backend/handlers/organizations.go` - `ClaimOwnershipHandler`
- `backend/main.go` - роут `/api/organizations/claim-ownership/{id}`

## API Endpoints

### POST /api/organizations
Создание организации

**Request:**
```json
{
  "name": "Название организации",
  "type": "shelter",
  "is_representative": true,
  // ... другие поля
}
```

**Response:**
```json
{
  "success": true,
  "data": {
    "id": 1
  }
}
```

### POST /api/organizations/claim-ownership/{id}
Заявка на владение организацией

**Headers:**
- `Authorization: Bearer {token}` (через cookie)

**Response:**
```json
{
  "success": true,
  "data": {
    "message": "You are now the owner of this organization"
  }
}
```

**Errors:**
- `404` - Organization not found
- `400` - Organization already has an owner
- `400` - You are already a member of this organization
- `401` - Unauthorized

## База данных

### Таблица organizations

Поле `owner_user_id` может быть:
- `NULL` - у организации нет владельца (публичная информация)
- `{user_id}` - ID пользователя-владельца

### Таблица organization_members

При создании организации с `is_representative=true` или при claim ownership:

```sql
INSERT INTO organization_members (
  organization_id, 
  user_id, 
  role, 
  can_post, 
  can_edit, 
  can_manage_members
) VALUES (
  {org_id}, 
  {user_id}, 
  'owner', 
  true, 
  true, 
  true
)
```

## UI/UX

### Страница создания организации

```
┌─────────────────────────────────────┐
│ Создание организации                │
├─────────────────────────────────────┤
│ Название: [________________]        │
│ Тип: [Приют для животных ▼]        │
│                                     │
│ ☑ Я представитель этой организации │
│                                     │
│ [Создать организацию]               │
└─────────────────────────────────────┘
```

### Страница организации без владельца

```
┌─────────────────────────────────────┐
│ Владелец не найден                  │
├─────────────────────────────────────┤
│ У этой организации нет владельца.   │
│ Если вы являетесь представителем    │
│ организации, вы можете заявить о    │
│ владении.                           │
│                                     │
│ [Я владелец]                        │
└─────────────────────────────────────┘
```

## Права доступа

### Owner (владелец)
- ✅ Публикация постов от имени организации
- ✅ Редактирование профиля организации
- ✅ Управление участниками (добавление, изменение ролей, удаление)
- ✅ Доступ к системе управления организацией
- ✅ Удаление организации

### Admin (администратор)
- ✅ Публикация постов от имени организации
- ✅ Редактирование профиля организации
- ✅ Управление участниками (добавление, изменение ролей, удаление)
- ✅ Доступ к системе управления организацией
- ❌ Удаление организации

### Moderator (модератор)
- ✅ Публикация постов от имени организации
- ❌ Редактирование профиля организации
- ❌ Управление участниками
- ✅ Доступ к системе управления организацией
- ❌ Удаление организации

### Member (участник)
- ❌ Публикация постов от имени организации
- ❌ Редактирование профиля организации
- ❌ Управление участниками
- ❌ Доступ к системе управления организацией
- ❌ Удаление организации

## Безопасность

### Проверки в ClaimOwnershipHandler

1. **Авторизация** - пользователь должен быть авторизован
2. **Существование организации** - организация должна существовать
3. **Отсутствие владельца** - у организации не должно быть owner
4. **Не участник** - пользователь не должен быть участником организации

### Логирование

```go
log.Printf("✅ User %d claimed ownership of organization %d", userID, orgID)
```

## Тестирование

### Сценарий 1: Создание организации представителем

1. Авторизоваться
2. Перейти на `/org/create`
3. Заполнить форму
4. Отметить "Я представитель этой организации"
5. Нажать "Создать организацию"
6. **Ожидаемый результат:** Пользователь становится owner, видит кнопку "Система управления"

### Сценарий 2: Создание организации без представителя

1. Авторизоваться
2. Перейти на `/org/create`
3. Заполнить форму
4. НЕ отмечать "Я представитель этой организации"
5. Нажать "Создать организацию"
6. **Ожидаемый результат:** Организация создана без owner, пользователь не видит кнопку "Система управления"

### Сценарий 3: Заявка на владение

1. Авторизоваться
2. Перейти на страницу организации без владельца
3. Увидеть блок "Владелец не найден"
4. Нажать "Я владелец"
5. Подтвердить действие
6. **Ожидаемый результат:** Пользователь становится owner, блок исчезает, появляется кнопка "Система управления"

### Сценарий 4: Попытка заявить о владении организацией с owner

1. Авторизоваться
2. Перейти на страницу организации с владельцем
3. **Ожидаемый результат:** Блок "Владелец не найден" не отображается

## Дата реализации

4 февраля 2026

## Автор

AI Assistant (Kiro)
