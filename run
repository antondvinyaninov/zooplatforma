#!/bin/bash

# Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ Go bin Ð² PATH
export PATH=$PATH:$(go env GOPATH)/bin

echo "ðŸš€ Starting Main Project..."
echo ""

# Ð¦Ð²ÐµÑ‚Ð° Ð´Ð»Ñ Ð²Ñ‹Ð²Ð¾Ð´Ð°
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m' # No Color

# Ð¤ÑƒÐ½ÐºÑ†Ð¸Ñ Ð´Ð»Ñ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ¸ Ð¿Ð¾Ñ€Ñ‚Ð°
check_port() {
    lsof -ti:$1 >/dev/null 2>&1
}

# Ð¤ÑƒÐ½ÐºÑ†Ð¸Ñ Ð´Ð»Ñ Ð¾Ñ‡Ð¸ÑÑ‚ÐºÐ¸ Ð¿Ð¾Ñ€Ñ‚Ð°
clean_port() {
    if check_port $1; then
        echo -e "${YELLOW}ðŸ§¹ Cleaning port $1...${NC}"
        lsof -ti:$1 | xargs kill -9 2>/dev/null || true
        sleep 1
    fi
}

# ÐžÑ‡Ð¸ÑÑ‚ÐºÐ° ÐºÑÑˆÐ°
echo -e "${BLUE}ðŸ§¹ Cleaning cache...${NC}"
rm -rf frontend/.next 2>/dev/null || true
echo -e "${GREEN}âœ… Cache cleared${NC}"
echo ""

# ÐžÑ‡Ð¸ÑÑ‚ÐºÐ° Ð¿Ð¾Ñ€Ñ‚Ð¾Ð²
echo -e "${BLUE}ðŸ§¹ Cleaning up ports...${NC}"
clean_port 7100  # Auth Service
clean_port 8100  # PetBase Service
clean_port 8000  # Main Backend
clean_port 3000  # Main Frontend
echo -e "${GREEN}âœ… Ports cleared${NC}"
echo ""

# Ð—Ð°Ð¿ÑƒÑÐº Auth Service
echo -e "${BLUE}ðŸ” Starting Auth Service on port 7100...${NC}"
(cd ../auth/backend && go run .) > /tmp/auth-service.log 2>&1 &
AUTH_PID=$!
sleep 3

if check_port 7100; then
    echo -e "${GREEN}âœ… Auth Service started (PID: $AUTH_PID)${NC}"
else
    echo -e "${RED}âŒ Failed to start Auth Service${NC}"
    cat /tmp/auth-service.log
    exit 1
fi
echo ""

# Ð—Ð°Ð¿ÑƒÑÐº PetBase Service
echo -e "${BLUE}ðŸ¾ Starting PetBase Service on port 8100...${NC}"
(cd ../petbase/backend && go run .) > /tmp/petbase-service.log 2>&1 &
PETBASE_PID=$!
sleep 3

if check_port 8100; then
    echo -e "${GREEN}âœ… PetBase Service started (PID: $PETBASE_PID)${NC}"
else
    echo -e "${RED}âŒ Failed to start PetBase Service${NC}"
    cat /tmp/petbase-service.log
    exit 1
fi
echo ""

# Ð—Ð°Ð¿ÑƒÑÐº Main Backend
echo -e "${BLUE}ðŸ”§ Starting Main Backend on port 8000...${NC}"
(cd backend && air) > /tmp/main-backend.log 2>&1 &
BACKEND_PID=$!
sleep 3

if check_port 8000; then
    echo -e "${GREEN}âœ… Main Backend started (PID: $BACKEND_PID)${NC}"
else
    echo -e "${RED}âŒ Failed to start Main Backend${NC}"
    cat /tmp/main-backend.log
    exit 1
fi
echo ""

# Ð—Ð°Ð¿ÑƒÑÐº Main Frontend
echo -e "${BLUE}âš›ï¸  Starting Main Frontend on port 3000...${NC}"
(cd frontend && npm run dev) > /tmp/main-frontend.log 2>&1 &
FRONTEND_PID=$!
sleep 3

if check_port 3000; then
    echo -e "${GREEN}âœ… Main Frontend started (PID: $FRONTEND_PID)${NC}"
else
    echo -e "${RED}âŒ Failed to start Main Frontend${NC}"
    cat /tmp/main-frontend.log
    exit 1
fi
echo ""

# Ð£ÑÐ¿ÐµÑˆÐ½Ñ‹Ð¹ Ð·Ð°Ð¿ÑƒÑÐº
echo -e "${GREEN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo -e "${GREEN}âœ… Main Project successfully started!${NC}"
echo -e "${GREEN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo ""
echo -e "${BLUE}ðŸ“ Services:${NC}"
echo -e "   ðŸ” Auth Service:    http://localhost:7100"
echo -e "   ðŸ¾ PetBase Service: http://localhost:8100"
echo -e "   ðŸ”§ Main Backend:    http://localhost:8000"
echo -e "   ðŸŒ Main Frontend:   ${GREEN}http://localhost:3000${NC}"
echo ""
echo -e "${YELLOW}ðŸ“ Logs:${NC}"
echo -e "   Auth:     tail -f /tmp/auth-service.log"
echo -e "   PetBase:  tail -f /tmp/petbase-service.log"
echo -e "   Backend:  tail -f /tmp/main-backend.log"
echo -e "   Frontend: tail -f /tmp/main-frontend.log"
echo ""
echo -e "${YELLOW}Press Ctrl+C to stop all services${NC}"
echo ""

# ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° Ctrl+C
trap "echo ''; echo -e '${RED}ðŸ›‘ Stopping all services...${NC}'; kill $AUTH_PID $PETBASE_PID $BACKEND_PID $FRONTEND_PID 2>/dev/null; sleep 1; echo -e '${GREEN}âœ… All services stopped${NC}'; exit" INT

# ÐžÐ¶Ð¸Ð´Ð°Ð½Ð¸Ðµ
wait
