#!/bin/bash

echo "ðŸš€ Starting Ð—Ð¾Ð¾ÐŸÐ»Ð°Ñ‚Ñ„Ð¾Ñ€Ð¼Ð°..."

# Clean cache
echo "ðŸ§¹ Cleaning cache..."
rm -rf main/frontend/.next 2>/dev/null || true
rm -rf admin/frontend/.next 2>/dev/null || true
rm -rf petbase/frontend/.next 2>/dev/null || true
rm -rf mobile/.expo 2>/dev/null || true
rm -rf mobile/node_modules/.cache 2>/dev/null || true
echo "âœ… Cache cleared"

# Kill processes on ports
echo "ðŸ§¹ Cleaning up ports..."
lsof -ti:3000 | xargs kill -9 2>/dev/null || true
lsof -ti:4000 | xargs kill -9 2>/dev/null || true
lsof -ti:4100 | xargs kill -9 2>/dev/null || true
lsof -ti:8000 | xargs kill -9 2>/dev/null || true
lsof -ti:8081 | xargs kill -9 2>/dev/null || true
lsof -ti:8100 | xargs kill -9 2>/dev/null || true
lsof -ti:9000 | xargs kill -9 2>/dev/null || true

echo "âœ… Ports cleared"

# Start main backend with Air
echo "ðŸ”§ Starting Main Backend on port 8000 (with hot reload)..."
(cd main/backend && /Users/dvinyaninov/go/bin/air) &
BACKEND_PID=$!

# Wait a bit for backend to start
sleep 2

# Start admin backend with Air
echo "ðŸ” Starting Admin Backend on port 9000 (with hot reload)..."
(cd admin/backend && /Users/dvinyaninov/go/bin/air) &
ADMIN_BACKEND_PID=$!

# Wait a bit for admin backend to start
sleep 1

# Start petbase backend with Air
echo "ðŸ¾ Starting PetBase Backend on port 8100 (with hot reload)..."
(cd petbase/backend && /Users/dvinyaninov/go/bin/air) &
PETBASE_BACKEND_PID=$!

# Start web frontend
echo "âš›ï¸  Starting Web Frontend on port 3000..."
(cd main/frontend && npm run dev) &
FRONTEND_PID=$!

# Start admin frontend
echo "ðŸ” Starting Admin Frontend on port 4000..."
(cd admin/frontend && npm run dev) &
ADMIN_FRONTEND_PID=$!

# Start petbase frontend
echo "ðŸ¾ Starting PetBase Frontend on port 4100..."
(cd petbase/frontend && npm run dev) &
PETBASE_FRONTEND_PID=$!

# Start mobile
echo "ðŸ“± Starting Mobile on port 8081 (Expo default)..."
(cd mobile && npm run web) &
MOBILE_PID=$!

echo ""
echo "â³ ÐžÐ¶Ð¸Ð´Ð°Ð½Ð¸Ðµ Ð·Ð°Ð¿ÑƒÑÐºÐ° ÑÐµÑ€Ð²Ð¸ÑÐ¾Ð²..."
sleep 3

echo ""
echo "ðŸ” ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð¿Ð¾Ñ€Ñ‚Ð¾Ð²:"
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÐºÐ°Ð¶Ð´Ñ‹Ð¹ Ð¿Ð¾Ñ€Ñ‚
check_port() {
  local port=$1
  local name=$2
  if lsof -i :$port -sTCP:LISTEN >/dev/null 2>&1; then
    echo "âœ… $name (Ð¿Ð¾Ñ€Ñ‚ $port) - Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½"
  else
    echo "âŒ $name (Ð¿Ð¾Ñ€Ñ‚ $port) - ÐÐ• Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½"
  fi
}

check_port 3000 "Web Frontend    "
check_port 4000 "Admin Frontend  "
check_port 4100 "PetBase Frontend"
check_port 8081 "Mobile          "
check_port 8000 "Main Backend    "
check_port 8100 "PetBase Backend "
check_port 9000 "Admin Backend   "

echo ""
echo "âœ… Ð—Ð¾Ð¾ÐŸÐ»Ð°Ñ‚Ñ„Ð¾Ñ€Ð¼Ð° Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½Ð°!"
echo ""
echo "   ðŸŒ Web Frontend:     http://localhost:3000"
echo "   ðŸ” Admin Frontend:   http://localhost:4000"
echo "   ðŸ¾ PetBase Frontend: http://localhost:4100"
echo "   ðŸ“± Mobile:           http://localhost:8081"
echo "   ðŸ”§ Main Backend:     http://localhost:8000"
echo "   ðŸ¾ PetBase Backend:  http://localhost:8100"
echo "   ðŸ›¡ï¸  Admin Backend:    http://localhost:9000"
echo ""
echo "ðŸ“š Ð”Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ð°Ñ†Ð¸Ñ:"
echo "   - ÐÐ´Ð¼Ð¸Ð½-Ð¿Ð°Ð½ÐµÐ»ÑŒ:  admin/README.md"
echo "   - Ð—Ð¾Ð¾Ð‘Ð°Ð·Ð°:       petbase/README.md"
echo "   - SSO Setup:     admin/SSO_SETUP.md"
echo "   - Ð¢ÐµÑÑ‚Ñ‹:         tests/README.md"
echo ""
echo "ðŸ§ª Ð¢ÐµÑÑ‚ SSO:        ./tests/debug-sso.sh"
echo ""
echo "Press Ctrl+C to stop all services"

# Wait for Ctrl+C
trap "echo ''; echo 'ðŸ›‘ Stopping all services...'; kill $BACKEND_PID $ADMIN_BACKEND_PID $PETBASE_BACKEND_PID $FRONTEND_PID $ADMIN_FRONTEND_PID $PETBASE_FRONTEND_PID $MOBILE_PID 2>/dev/null; exit" INT
wait
