#!/bin/bash

echo "ðŸš€ Starting Ð—Ð¾Ð¾ÐŸÐ»Ð°Ñ‚Ñ„Ð¾Ñ€Ð¼Ð°..."

# Clean cache
echo "ðŸ§¹ Cleaning cache..."
rm -rf main/frontend/.next 2>/dev/null || true
rm -rf admin/frontend/.next 2>/dev/null || true
rm -rf petbase/frontend/.next 2>/dev/null || true
rm -rf shelter/frontend/.next 2>/dev/null || true
rm -rf owner/frontend/.next 2>/dev/null || true
rm -rf volunteer/frontend/.next 2>/dev/null || true
rm -rf clinic/frontend/.next 2>/dev/null || true
rm -rf mobile/.expo 2>/dev/null || true
rm -rf mobile/node_modules/.cache 2>/dev/null || true
echo "âœ… Cache cleared"

# Function to kill process on port
kill_port() {
  local port=$1
  local max_attempts=3
  local attempt=1
  
  while [ $attempt -le $max_attempts ]; do
    local pids=$(lsof -ti:$port 2>/dev/null)
    if [ -z "$pids" ]; then
      return 0
    fi
    
    if [ $attempt -eq 1 ]; then
      echo "   Killing processes on port $port: $pids"
    else
      echo "   Attempt $attempt: Forcing kill on port $port..."
    fi
    
    # ÐŸÑ€Ð¾Ð±ÑƒÐµÐ¼ Ñ€Ð°Ð·Ð½Ñ‹Ðµ ÑÐ¸Ð³Ð½Ð°Ð»Ñ‹
    if [ $attempt -eq 1 ]; then
      echo "$pids" | xargs kill -15 2>/dev/null || true  # SIGTERM
      sleep 0.3
    elif [ $attempt -eq 2 ]; then
      echo "$pids" | xargs kill -9 2>/dev/null || true   # SIGKILL
      sleep 0.5
    else
      # ÐŸÐ¾ÑÐ»ÐµÐ´Ð½ÑÑ Ð¿Ð¾Ð¿Ñ‹Ñ‚ÐºÐ° - ÑƒÐ±Ð¸Ð²Ð°ÐµÐ¼ Ñ‡ÐµÑ€ÐµÐ· sudo (Ð´Ð»Ñ ÑÐ¸ÑÑ‚ÐµÐ¼Ð½Ñ‹Ñ… Ð¿Ñ€Ð¾Ñ†ÐµÑÑÐ¾Ð²)
      echo "$pids" | xargs sudo kill -9 2>/dev/null || true
      sleep 0.5
    fi
    
    attempt=$((attempt + 1))
  done
  
  # Ð¤Ð¸Ð½Ð°Ð»ÑŒÐ½Ð°Ñ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ°
  local remaining=$(lsof -ti:$port 2>/dev/null)
  if [ ! -z "$remaining" ]; then
    echo "   âš ï¸  WARNING: Port $port still occupied by PID $remaining"
    echo "   Process info:"
    lsof -i :$port | head -2
    return 1
  fi
  return 0
}

# Kill processes on ports
echo "ðŸ§¹ Cleaning up ports..."
kill_port 3000
kill_port 4000
kill_port 4100
kill_port 5100
kill_port 6100
kill_port 6200
kill_port 6300
kill_port 8000
kill_port 8081
kill_port 8100
kill_port 8200
kill_port 8400
kill_port 8500
kill_port 8600
kill_port 9000

echo "âœ… Ports cleared"

# Final check - wait a bit for ports to be fully released
sleep 1

# Verify ports are free
echo "ðŸ” Verifying ports are free..."
for port in 3000 4000 4100 5100 6100 6200 6300 8000 8081 8100 8200 8400 8500 8600 9000; do
  if lsof -i :$port -sTCP:LISTEN >/dev/null 2>&1; then
    echo "   âš ï¸  WARNING: Port $port is still occupied!"
    lsof -i :$port
  fi
done

# Start main backend with Air
echo "ðŸ”§ Starting Main Backend on port 8000 (with hot reload)..."
(cd main/backend && /Users/dvinyaninov/go/bin/air) &
BACKEND_PID=$!

# Wait a bit for backend to start
sleep 2

# Start admin backend with Air
echo "ðŸ” Starting Admin Backend on port 9000 (with hot reload)..."
(cd admin/backend && /Users/dvinyaninov/go/bin/air) &
ADMIN_BACKEND_PID=$!

# Wait a bit for admin backend to start
sleep 1

# Start petbase backend with Air
echo "ðŸ¾ Starting PetBase Backend on port 8100 (with hot reload)..."
(cd petbase/backend && /Users/dvinyaninov/go/bin/air) &
PETBASE_BACKEND_PID=$!

# Start shelter backend with Air
echo "ðŸ  Starting Shelter Backend on port 8200 (with hot reload)..."
(cd shelter/backend && /Users/dvinyaninov/go/bin/air) &
SHELTER_BACKEND_PID=$!

# Start owner backend with Air
echo "ðŸ‘¤ Starting Owner Backend on port 8400 (with hot reload)..."
(cd owner/backend && /Users/dvinyaninov/go/bin/air) &
OWNER_BACKEND_PID=$!

# Start volunteer backend with Air
echo "ðŸ¤ Starting Volunteer Backend on port 8500 (with hot reload)..."
(cd volunteer/backend && /Users/dvinyaninov/go/bin/air) &
VOLUNTEER_BACKEND_PID=$!

# Start clinic backend with Air
echo "ðŸ¥ Starting Clinic Backend on port 8600 (with hot reload)..."
(cd clinic/backend && /Users/dvinyaninov/go/bin/air) &
CLINIC_BACKEND_PID=$!

# Start web frontend
echo "âš›ï¸  Starting Web Frontend on port 3000..."
(cd main/frontend && npm run dev) &
FRONTEND_PID=$!

# Start admin frontend
echo "ðŸ” Starting Admin Frontend on port 4000..."
(cd admin/frontend && npm run dev) &
ADMIN_FRONTEND_PID=$!

# Start petbase frontend
echo "ðŸ¾ Starting PetBase Frontend on port 4100..."
(cd petbase/frontend && npm run dev) &
PETBASE_FRONTEND_PID=$!

# Start shelter frontend
echo "ðŸ  Starting Shelter Frontend on port 5100..."
(cd shelter/frontend && npm run dev) &
SHELTER_FRONTEND_PID=$!

# Start owner frontend
echo "ðŸ‘¤ Starting Owner Frontend on port 6100..."
# Ð”Ð¾Ð¿Ð¾Ð»Ð½Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð°Ñ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð¸ Ð¾Ñ‡Ð¸ÑÑ‚ÐºÐ° Ð¿Ð¾Ñ€Ñ‚Ð° 6100 Ð¿ÐµÑ€ÐµÐ´ Ð·Ð°Ð¿ÑƒÑÐºÐ¾Ð¼
if lsof -i :6100 -sTCP:LISTEN >/dev/null 2>&1; then
  echo "   âš ï¸  Port 6100 still occupied, forcing cleanup..."
  lsof -ti:6100 | xargs sudo kill -9 2>/dev/null || true
  sleep 1
fi
(cd owner/frontend && npm run dev) &
OWNER_FRONTEND_PID=$!

# Start volunteer frontend
echo "ðŸ¤ Starting Volunteer Frontend on port 6200..."
# Ð”Ð¾Ð¿Ð¾Ð»Ð½Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð°Ñ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð¸ Ð¾Ñ‡Ð¸ÑÑ‚ÐºÐ° Ð¿Ð¾Ñ€Ñ‚Ð° 6200 Ð¿ÐµÑ€ÐµÐ´ Ð·Ð°Ð¿ÑƒÑÐºÐ¾Ð¼
if lsof -i :6200 -sTCP:LISTEN >/dev/null 2>&1; then
  echo "   âš ï¸  Port 6200 still occupied, forcing cleanup..."
  lsof -ti:6200 | xargs sudo kill -9 2>/dev/null || true
  sleep 1
fi
(cd volunteer/frontend && npm run dev) &
VOLUNTEER_FRONTEND_PID=$!

# Start clinic frontend
echo "ðŸ¥ Starting Clinic Frontend on port 6300..."
# Ð”Ð¾Ð¿Ð¾Ð»Ð½Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð°Ñ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð¸ Ð¾Ñ‡Ð¸ÑÑ‚ÐºÐ° Ð¿Ð¾Ñ€Ñ‚Ð° 6300 Ð¿ÐµÑ€ÐµÐ´ Ð·Ð°Ð¿ÑƒÑÐºÐ¾Ð¼
if lsof -i :6300 -sTCP:LISTEN >/dev/null 2>&1; then
  echo "   âš ï¸  Port 6300 still occupied, forcing cleanup..."
  lsof -ti:6300 | xargs sudo kill -9 2>/dev/null || true
  sleep 1
fi
(cd clinic/frontend && npm run dev) &
CLINIC_FRONTEND_PID=$!

# Start mobile
echo "ðŸ“± Starting Mobile on port 8081 (Expo default)..."
(cd mobile && npm run web) &
MOBILE_PID=$!

echo ""
echo "â³ ÐžÐ¶Ð¸Ð´Ð°Ð½Ð¸Ðµ Ð·Ð°Ð¿ÑƒÑÐºÐ° ÑÐµÑ€Ð²Ð¸ÑÐ¾Ð²..."
sleep 3

echo ""
echo "ðŸ” ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð¿Ð¾Ñ€Ñ‚Ð¾Ð²:"
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÐºÐ°Ð¶Ð´Ñ‹Ð¹ Ð¿Ð¾Ñ€Ñ‚
check_port() {
  local port=$1
  local name=$2
  if lsof -i :$port -sTCP:LISTEN >/dev/null 2>&1; then
    echo "âœ… $name (Ð¿Ð¾Ñ€Ñ‚ $port) - Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½"
  else
    echo "âŒ $name (Ð¿Ð¾Ñ€Ñ‚ $port) - ÐÐ• Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½"
  fi
}

check_port 3000 "Web Frontend       "
check_port 4000 "Admin Frontend     "
check_port 4100 "PetBase Frontend   "
check_port 5100 "Shelter Frontend   "
check_port 6100 "Owner Frontend     "
check_port 6200 "Volunteer Frontend "
check_port 6300 "Clinic Frontend    "
check_port 8081 "Mobile             "
check_port 8000 "Main Backend       "
check_port 8100 "PetBase Backend    "
check_port 8200 "Shelter Backend    "
check_port 8400 "Owner Backend      "
check_port 8500 "Volunteer Backend  "
check_port 8600 "Clinic Backend     "
check_port 9000 "Admin Backend      "

echo ""
echo "âœ… Ð—Ð¾Ð¾ÐŸÐ»Ð°Ñ‚Ñ„Ð¾Ñ€Ð¼Ð° Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½Ð°!"
echo ""
echo "   ðŸŒ Web Frontend:        http://localhost:3000"
echo "   ðŸ” Admin Frontend:      http://localhost:4000"
echo "   ðŸ¾ PetBase Frontend:    http://localhost:4100"
echo "   ðŸ  Shelter Frontend:    http://localhost:5100"
echo "   ðŸ‘¤ Owner Frontend:      http://localhost:6100"
echo "   ðŸ¤ Volunteer Frontend:  http://localhost:6200"
echo "   ðŸ¥ Clinic Frontend:     http://localhost:6300"
echo "   ðŸ“± Mobile:              http://localhost:8081"
echo "   ðŸ”§ Main Backend:        http://localhost:8000"
echo "   ðŸ¾ PetBase Backend:     http://localhost:8100"
echo "   ðŸ  Shelter Backend:     http://localhost:8200"
echo "   ðŸ‘¤ Owner Backend:       http://localhost:8400"
echo "   ðŸ¤ Volunteer Backend:   http://localhost:8500"
echo "   ðŸ¥ Clinic Backend:      http://localhost:8600"
echo "   ðŸ›¡ï¸  Admin Backend:       http://localhost:9000"
echo ""
echo "ðŸ“š Ð”Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ð°Ñ†Ð¸Ñ:"
echo "   - ÐÐ´Ð¼Ð¸Ð½-Ð¿Ð°Ð½ÐµÐ»ÑŒ:     admin/README.md"
echo "   - Ð—Ð¾Ð¾Ð‘Ð°Ð·Ð°:          petbase/README.md"
echo "   - ÐŸÑ€Ð¸ÑŽÑ‚:            shelter/README.md"
echo "   - Ð’Ð»Ð°Ð´ÐµÐ»ÐµÑ†:         owner/README.md"
echo "   - Ð—Ð¾Ð¾Ð¿Ð¾Ð¼Ð¾Ñ‰Ð½Ð¸Ðº:      volunteer/README.md"
echo "   - Ð’ÐµÑ‚ÐºÐ»Ð¸Ð½Ð¸ÐºÐ°:       clinic/README.md"
echo "   - SSO Setup:        admin/SSO_SETUP.md"
echo "   - Ð¢ÐµÑÑ‚Ñ‹:            tests/README.md"
echo ""
echo "ðŸ§ª Ð¢ÐµÑÑ‚ SSO:        ./tests/debug-sso.sh"
echo ""
echo "Press Ctrl+C to stop all services"

# Wait for Ctrl+C
trap "echo ''; echo 'ðŸ›‘ Stopping all services...'; kill $BACKEND_PID $ADMIN_BACKEND_PID $PETBASE_BACKEND_PID $SHELTER_BACKEND_PID $OWNER_BACKEND_PID $VOLUNTEER_BACKEND_PID $CLINIC_BACKEND_PID $FRONTEND_PID $ADMIN_FRONTEND_PID $PETBASE_FRONTEND_PID $SHELTER_FRONTEND_PID $OWNER_FRONTEND_PID $VOLUNTEER_FRONTEND_PID $CLINIC_FRONTEND_PID $MOBILE_PID 2>/dev/null; exit" INT
wait
